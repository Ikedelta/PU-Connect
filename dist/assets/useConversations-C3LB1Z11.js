import{b as _,u as w,c as f}from"./query-vendor-Cpskl8RO.js";import{u as y,s as n}from"./index-DVwrR-_V.js";function C(){const{user:e}=y(),{data:u=[],isLoading:i}=_({queryKey:["conversations",e?.id],queryFn:async()=>{if(!e)return[];const{data:r,error:o}=await n.from("conversations").select(`
          *,
          buyer:profiles!buyer_id(id, full_name, email, avatar_url, is_online, last_seen),
          seller:profiles!seller_id(id, full_name, email, avatar_url, is_online, last_seen),
          product:products(id, name)
        `).or(`buyer_id.eq.${e.id},seller_id.eq.${e.id}`).order("last_message_at",{ascending:!1});if(o)throw o;const d=r?.map(t=>t.id)||[],{data:a}=await n.from("messages").select("conversation_id").in("conversation_id",d).neq("sender_id",e.id).eq("is_read",!1),s=a?.reduce((t,c)=>(t[c.conversation_id]=(t[c.conversation_id]||0)+1,t),{})||{};return r?.map(t=>({...t,other_user:t.buyer_id===e.id?t.seller:t.buyer,unread_count:s[t.id]||0}))||[]},enabled:!!e,staleTime:1e3*60*10,refetchInterval:6e4}),{data:l=0}=_({queryKey:["unread-count",e?.id],queryFn:async()=>{if(!e)return 0;const{data:r}=await n.from("conversations").select("id").or(`buyer_id.eq.${e.id},seller_id.eq.${e.id}`);if(!r||r.length===0)return 0;const o=r.map(a=>a.id),{count:d}=await n.from("messages").select("*",{count:"exact",head:!0}).in("conversation_id",o).neq("sender_id",e.id).eq("is_read",!1);return d||0},enabled:!!e,staleTime:1e3*60*5,refetchInterval:6e4});return{conversations:u,isLoading:i,totalUnreadCount:l}}function Q(e){const{user:u}=y(),i=w(),{data:l=[],isLoading:r}=_({queryKey:["messages",e],queryFn:async()=>{if(!e)return[];const{data:a,error:s}=await n.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(s)throw s;return a||[]},enabled:!!e,staleTime:1e3*60*5,refetchInterval:1e4}),o=f({mutationFn:async({message:a,receiverId:s,file:t})=>{if(!e||!u)throw new Error("Missing required data");let c=null,m=null;if(t){const b=t.name.split(".").pop(),q=`${e}/${Date.now()}_${Math.random().toString(36).substring(7)}.${b}`,{error:h}=await n.storage.from("chat-attachments").upload(q,t);if(h)throw h;const{data:$}=n.storage.from("chat-attachments").getPublicUrl(q);c=$.publicUrl,t.type.startsWith("image/")?m="image":t.type.startsWith("video/")?m="video":m="file"}const{data:p,error:g}=await n.from("messages").insert({conversation_id:e,sender_id:u.id,receiver_id:s,message:a,attachment_url:c,attachment_type:m,is_read:!1}).select().single();if(g)throw g;const v=t?a?`ðŸ“· ${a}`:"Sent an attachment":a;return await n.from("conversations").update({last_message:v,last_message_at:new Date().toISOString()}).eq("id",e),p},onSuccess:()=>{i.invalidateQueries({queryKey:["messages",e]}),i.invalidateQueries({queryKey:["conversations"]})}}),d=f({mutationFn:async a=>{if(!u||a.length===0)return;const{error:s}=await n.from("messages").update({is_read:!0}).in("id",a).neq("sender_id",u.id);if(s)throw s},onSuccess:()=>{i.invalidateQueries({queryKey:["messages",e]}),i.invalidateQueries({queryKey:["conversations"]}),i.invalidateQueries({queryKey:["unread-count"]})}});return{messages:l,isLoading:r,sendMessage:o,markAsRead:d}}function D(){const{user:e}=y(),u=w();return f({mutationFn:async({otherUserId:i,productId:l})=>{if(!e)throw new Error("Not authenticated");let r=n.from("conversations").select("id").or(`and(buyer_id.eq.${e.id},seller_id.eq.${i}),and(buyer_id.eq.${i},seller_id.eq.${e.id})`);l&&(r=r.eq("product_id",l));const{data:o,error:d}=await r.maybeSingle();if(d)throw d;if(o)return o.id;const{data:a,error:s}=await n.from("conversations").insert({buyer_id:e.id,seller_id:i,product_id:l||null,last_message:"",last_message_at:new Date().toISOString()}).select("id").single();if(s)throw s;return a.id},onSuccess:()=>{u.invalidateQueries({queryKey:["conversations"]})}})}export{D as a,Q as b,C as u};
//# sourceMappingURL=useConversations-C3LB1Z11.js.map
